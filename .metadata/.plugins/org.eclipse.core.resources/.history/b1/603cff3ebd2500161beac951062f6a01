package jammazwan;

import org.apache.camel.Exchange;
import org.apache.camel.Processor;
import org.apache.camel.builder.RouteBuilder;

import jammazwan.util.ReadMeGenerate;

public class InputRouteBuilder extends RouteBuilder {
	String abcPrefix;
	ReadMeGenerate readMeGenerator;
	String rootDir;

	public InputRouteBuilder(String abcPrefix) {
		this.abcPrefix = abcPrefix;
		this.readMeGenerator = new ReadMeGenerate(abcPrefix);
		this.rootDir = "" + readMeGenerator.getName() + "/";
	}

	public void configure() {
		
		/*
		 * First three are velocity templates, where substitutions are made
		 */
		from("file:src/main/resources/velocity?noop=true&delete=false&fileName=README.txt.vm")
				.process(getVelocityMapProcessor()).to("velocity://velocity/README.txt.vm")
				.process(getProcessor(rootDir)).to(getFolder());

		from("file:src/main/resources/velocity?noop=true&delete=false&fileName=pom.xml.vm")
				.process(getVelocityMapProcessor()).to("velocity://velocity/pom.xml.vm").process(getProcessor(rootDir))
				.to(getFolder());

		from("file:src/main/resources/velocity?noop=true&delete=false&fileName=project.vm")
				.process(getVelocityMapProcessor()).to("velocity://velocity/project.vm")
				.process(getProcessor(rootDir + ".")).to(getFolder());
		

		/*
		 * This group consumes 3letter name to rename file
		 */
		from("file:src/main/resources/velocity?noop=true&delete=false&fileName=ExampleRoute.java.vm")
		.process(getVelocityMapProcessor()).to("velocity://velocity/ExampleRoute.java.vm")
		.process(getProcessor(rootDir + "src/main/java/" + abcPrefix + "/")).to(getFolder());
		

		/*
		 * Remaining are straight file copy and rename. Creation of empty
		 * folders done with .gitkeep file, per normal conventions
		 */
		from("file:src/main/resources/velocity?noop=true&delete=false&fileName=example.xml.vm")
		.process(getProcessor(rootDir + "src/main/resources/META-INF/spring/")).to(getFolder());
		
		from("file:src/main/resources/velocity?noop=true&delete=false&fileName=ExampleTest.java.vm")
		.process(getProcessor(rootDir + "src/test/java/" + abcPrefix + "/")).to(getFolder());

		from("file:src/main/resources/velocity?noop=true&delete=false&fileName=ExampleBean.java.vm")
		.process(getProcessor(rootDir + "src/main/java/" + abcPrefix + "/")).to(getFolder());
		
		from("file:src/main/resources/velocity?noop=true&delete=false&fileName=gitkeep2.vm")
				.process(getProcessor(rootDir + "src/test/resources/.")).to(getFolder());
		
		from("file:src/main/resources/velocity?noop=true&delete=false&fileName=classpath.vm")
				.to("velocity://velocity/classpath.vm").process(getProcessor(rootDir + ".")).to(getFolder());

		from("file:src/main/resources/velocity?noop=true&delete=false&fileName=gitkeep3.vm")
				.process(getProcessor(rootDir + "src/main/resources/META-INF/spring/.")).to(getFolder());

		from("file:src/main/resources/velocity?noop=true&delete=false&fileName=log4j.properties.vm")
				.process(getProcessor(rootDir + "src/main/resources/")).to(getFolder());

		from("file:src/main/resources/velocity?noop=true&delete=false&fileName=gitkeep5.vm")
				.process(getProcessor(rootDir + "src/test/java/" + abcPrefix + "/.")).to(getFolder());

		from("file:src/main/resources/velocity?noop=true&delete=false&fileName=gitkeep1.vm")
				.process(getProcessor(rootDir + "src/main/java/" + abcPrefix + "/.")).to(getFolder());
	}

	private Processor getProcessor(final String prefix) {
		return new Processor() {
			public void process(Exchange exchange) throws Exception {
				String fileName = "" + exchange.getIn().getHeader("CamelFileName");
				fileName = fileName.substring(0, fileName.length() - 3);
				exchange.getIn().setHeader("CamelFileName", constant(prefix + fileName));
			}
		};
	}

	private Processor getVelocityMapProcessor() {
		return new Processor() {
			public void process(Exchange exchange) throws Exception {
				exchange.getIn().setHeader("readme", readMeGenerator.getString());
				exchange.getIn().setHeader("projectname", readMeGenerator.getName() );
				exchange.getIn().setHeader("pckg", abcPrefix );
			}
		};
	}

	String getFolder() {
		return "file://generated";
	}

}
